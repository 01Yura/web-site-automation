<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Доступ к Selenoid и конфигурации</title>
    <link rel="icon" type="image/png" href="../favicon.png" />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="../assets/copy-code.js"></script>
    <style>
      /* Smaller font size for list items on this page */
      ul li,
      ol li {
        font-size: 0.95em;
      }
      /* Ensure nested lists inside tips match surrounding text size */
      .tips ul,
      .tips ul li {
        font-size: inherit;
      }
    </style>
  </head>
  <body>
    <div class="language-switcher">
      <a href="../index.html" class="lang-link">Главная</a>
      <span class="lang-separator">|</span>
      <a href="selenoid.html" class="lang-link active">RU</a>
      <span class="lang-separator">|</span>
      <a href="../en/selenoid.html" class="lang-link">EN</a>
    </div>

    <h1>Доступ к Selenoid и конфигурации</h1>

    <div class="warning">
      <strong>ВНИМАНИЕ!</strong> У меня не получилось поднять Selenoid на
      Windows 10 c Docker Desktop (версия Docker Engine 26.1.4; после обновления до версии 28.1.5 всё заработало) и на MacBook с чипом M1 (Apple Silicon), хотя на Мак есть
      костыль (<a
        href="https://gist.github.com/AlexRogalskiy/b266e960606dc565c22c3e6bfd9f48df"
        target="_blank"
        rel="noopener"
        >ссылка</a
      >), но он работает только для Chrome версии 91. Удалось запустить только
      на Linux (Ubuntu; вероятно, заработает и на других дистрибутивах Linux) и
      на Windows 11. Ну и на более свежих MacBook'ах.
    </div>

    <ul>
      <li>
        Доступ к <strong>Selenoid</strong>:
        <a href="http://176.126.103.46:4444/status" target="_blank" rel="noopener"
          >просмотреть на странице</a
        >
      </li>
      <li>
        Доступ к <strong>Selenoid UI</strong>:
        <a href="https://it-yura.online/app" target="_blank" rel="noopener"
          >просмотреть на странице</a
        >
        (не запускайте UI тесты в несколько потоков, так как сервер ляжет из-за
        небольшого кол-ва RAM)
      </li>
      <li>
        <strong>browsers.json</strong>:
        <a href="browsers.html">просмотреть на странице</a>
      </li>
      <li>
        <strong>docker-compose.yml</strong> (Selenoid + UI):
        <a href="docker-compose.html">просмотреть на странице</a>
      </li>
      <li>
        <strong>docker-compose.yml c видеозаписью</strong>:
        <a href="docker-compose-video.html">просмотреть на странице</a>
      </li>
    </ul>

    <div class="tips">
      <h1>Типичные ошибки при настройке Selenoid и запуске автотестов</h1>
      <ol>
        <li>
          <strong
            >Не скачаны образы браузеров указанные в файле
            <code>browsers.json</code>.</strong
          >
          <ul>
            <li>
              Selenoid не загружает образы браузеров автоматически,
              соответственно тесты не стартуют из-за отсутствия образа.
              Необходимо скачать вручную образы браузеров, указанные в файле
              <code>browsers.json</code>.
            </li>
          </ul>
        </li>

        <li>
          <strong
            >Есть синтаксические ошибки в <code>browsers.json</code>.</strong
          >
          <ul>
            <li>
              Для браузеров "chrome" и "opera" ключ
              <code>path</code> в файле <code>browsers.json</code> должен быть
              <code>"/"</code>, а не <code>"/wd/hub"</code>. Для браузера
              "firefox" ключ остается <code>"/wd/hub"</code>. Будьте с этим
              внимательны, иначе браузер не стартанет.
            </li>
            <li>
              Опечатки в названии образа/тега версии браузера в файле
              <code>browsers.json</code> (часто бывает путаница в расположении
              нижнего_подчеркивания или двоеточия при указании версии образа,
              чат гпт этим грешит). Например, вместо
              <code>selenoid/vnc_chrome:128.0</code> написано
              <code>selenoid/vnc_chrome_128.0</code>.
            </li>
          </ul>
        </li>

        <li>
          <strong>Ошибки путей в файле docker-compose.yml (volumes).</strong>
          <ul>
            <li>
              Из-за неверных путей Selenoid не видит
              файл <code>browsers.json</code>, UI не коннектится к Selenoid, и
              не пишутся видео. Проверьте монтирование каталогов (пути,
              указанные как volumes) — это частая ошибка.
            </li>
          </ul>
        </li>

        <li>
          <strong
            >Видео не пишется, так как запись видео настроена неправильно.</strong
          >
          <ul>
            <li>
              По сути в docker-compose.yml нужно просто добавить переменную
              окружения с <u>абсолютным путём</u> до папки <code>video</code>:
              <pre>
environment:
  OVERRIDE_VIDEO_OUTPUT_DIR: /root/selenoid_with_video/video</pre
              >
              Здесь нельзя использовать <code>${PWD}</code> или
              <code>./video</code> — требуется именно абсолютный путь! Подробнее
              об этом можно почитать в их официальной доке:
              <a
                href="https://aerokube.com/selenoid/latest/#_video_recording"
                target="_blank"
                rel="noopener"
                >aerokube.com/selenoid … video_recording</a
              >.
            </li>
            <li>
              Плюс часто забывают заранее скачать образ рекордера (Selenoid сам
              его не скачает и видеозапись не будет работать):
              <code>docker pull selenoid/video-recorder:latest-release</code>. Добавлять этот образ в docker-compose.yml не нужно, он запустится автоматически, главное просто скачать его один раз.
            </li>
            <li>
              В тестах нельзя использовать headless-режим:
              <pre>Configuration.headless = true;</pre>
              Значение следует удалить полностью или заменить на
              <pre>Configuration.headless = false;</pre>
              Если нет экрана, записывать нечего.
            </li>
          </ul>
        </li>

        <li>
          <strong>Проблемы на Windows 10 (версия Docker Engine 26.1.4; после обновления до версии 28.1.5 всё заработало) и Mac с чипом M1.</strong>
          <ul>
            <li>
              Контейнеры поднимаются, но браузер стартует и сразу падает. Если используете Windows, то обновите докер; для Mac существуют
              костыльные варианты только для Chrome версии 91 (
              <a
                href="https://gist.github.com/AlexRogalskiy/b266e960606dc565c22c3e6bfd9f48df"
                target="_blank"
                rel="noopener"
                >ссылка</a
              >). Рекомендация - использовать Linux-хост или VM/VPS (например,
              Ubuntu Server 22.04, ≥10&nbsp;GB диска, ≥2&nbsp;GB RAM), свежий
              MacBook или Windows 11.
            </li>
          </ul>
        </li>

        <li>
          <strong
            >Частая ошибка: Неверный IP-адрес тестируемого приложения в
            тестах.</strong
          >
          <ul>
            <li>
              В контейнере нельзя использовать <code>localhost</code> для
              обращения к приложению, запущенному вне контейнера - указывайте
              реальный IP-адрес хоста. <br />Пример правильно:
              <pre>Configuration.baseUrl = "http://192.168.0.127:3000";</pre>
              Пример неправильно:
              <pre>Configuration.baseUrl = "http://localhost:3000";</pre>
              Тут обязательно должен быть IP-адрес, а не localhost, так как
              данный URL подставляется в адресную строку браузера, открытого в
              контейнере Docker, и если указать localhost, то контейнер будет
              думать, что приложение запущено тоже внутри этого же самого
              контейнера, а оно запущено не в нём.
            </li>
          </ul>
        </li>

        <li>
          <strong>Проверка браузеров вручную в UI.</strong>
          <ul>
            <li>
              И вообще после установки Selenoid, Selenoid UI и скачивания
              образов браузеров нужно убедиться, что браузеры просто открываются
              хотя бы вручную, чтобы потом, если что-то не заработает, понять —
              дело в тестах или в конфигурации Selenoid. Для этого после запуска
              Selenoid (docker-compose up -d) зайдите на его
              IP-адрес:8080, сверху справа должно быть 2 надписи CONNECTED,
              затем перейдите во вкладку CAPABILITIES, выберите браузер из
              выпадающего списка (если списка нет, то проблема в browsers.json
              или в пути к нему) и запустите его вручную. Должно появиться окно
              браузера. Если появилось — поздравляю, Selenoid настроен; теперь
              главное — правильно всё прописать в самих тестах.
            </li>
          </ul>
        </li>
      </ol>
    </div>
  </body>
</html>
