services:
  # Zookeeper для Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: kafka-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - spring-library-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Kafka Broker
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-broker
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka-broker:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168 # 7 дней
      KAFKA_LOG_SEGMENT_BYTES: 1073741824 # 1GB
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      # Ограничение памяти для Kafka (heap memory)
      KAFKA_HEAP_OPTS: "-Xmx512M -Xms512M"
    networks:
      - spring-library-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped

  # Kafka UI - графический интерфейс для просмотра топиков и сообщений
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_started
    ports:
      - "8089:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-broker:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      # Аутентификация через Basic Auth
      AUTH_TYPE: ${KAFKA_UI_AUTH_TYPE:-BASIC}
      SPRING_SECURITY_USER_NAME: ${KAFKA_UI_USERNAME:-admin}
      SPRING_SECURITY_USER_PASSWORD: ${KAFKA_UI_PASSWORD:-admin}
    networks:
      - spring-library-network
    restart: unless-stopped

  # MailHog - SMTP сервер для разработки и тестирования email
  # Веб-интерфейс: http://localhost:8025
  # SMTP порт: 1025
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog_email_server
    ports:
      - "1025:1025" # SMTP порт
      - "8025:8025" # Web UI для просмотра писем
    networks:
      - spring-library-network
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    image: 01yura/spring-digital-bookstore-analytics-service:prometheus
    pull_policy: always
    container_name: analytics-service
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8090:8090"
    environment:
      # Kafka Configuration
      KAFKA_BOOTSTRAP_SERVERS: kafka-broker:29092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-broker:29092
      KAFKA_CONSUMER_GROUP_ID: analytics-service-group
      SPRING_KAFKA_CONSUMER_GROUP_ID: analytics-service-group
      # Server Configuration
      SERVER_PORT: 8090
      # Logging
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_ORG_APACHE_KAFKA: WARN
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_KAFKA: INFO
      LOGGING_LEVEL_ONLINE_ITYURA_ANALYTICS: INFO
      # Aggregation interval
      ANALYTICS_AGGREGATION_INTERVAL_MS: ${ANALYTICS_AGGREGATION_INTERVAL_MS:-60000}
      # ELK Stack настройки для отправки логов в Logstash
      LOGSTASH_HOST: logstash
      LOGSTASH_PORT: 5000
      LOGSTASH_ENABLED: "true"
    networks:
      - spring-library-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:8090/api/analytics/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # React UI приложение
  ui:
    image: 01yura/spring-digital-library-ui:with_analytics_and_email_without_https_for_local_run
    pull_policy: always
    container_name: spring-digital-bookstore-ui
    ports:
      - "80:80"
    networks:
      - spring-library-network
    depends_on:
      - backend
    restart: unless-stopped

  # PostgreSQL база данных для локального запуска
  postgres:
    image: postgres:16-alpine
    container_name: spring-digital-library-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-spring_digital_bookstore}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
    ports:
      - "5432:5432"
    volumes:
      # Хранение данных БД на хосте (для Windows используйте формат C:/path/to/dir)
      - ${POSTGRES_DATA_PATH:-C:/spring-digital-bookstore/postgres_data}:/var/lib/postgresql/data
    networks:
      - spring-library-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d spring_digital_bookstore"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Spring Boot приложение для локального запуска без HTTPS
  backend:
    image: 01yura/spring-digital-bookstore:prometheus
    pull_policy: always
    container_name: spring-digital-bookstore-app
    environment:
      # Настройки подключения к БД
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-spring_digital_bookstore}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-admin}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-admin}

      # JPA/Hibernate настройки
      SPRING_JPA_DATABASE_PLATFORM: ${SPRING_JPA_DATABASE_PLATFORM:-org.hibernate.dialect.PostgreSQLDialect}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}
      SPRING_JPA_SHOW_SQL: ${SPRING_JPA_SHOW_SQL:-false}
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: ${SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL:-true}

      # JWT настройки
      JWT_SECRET: ${JWT_SECRET:-my-secret-key-for-jwt-generation}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-300000}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-86400000}

      # Swagger/OpenAPI настройки
      SPRINGDOC_API_DOCS_PATH: ${SPRINGDOC_API_DOCS_PATH:-/v3/api-docs}
      SPRINGDOC_SWAGGER_UI_PATH: ${SPRINGDOC_SWAGGER_UI_PATH:-/swagger-ui.html}
      SPRINGDOC_SWAGGER_UI_OPERATIONS_SORTER: ${SPRINGDOC_SWAGGER_UI_OPERATIONS_SORTER:-method}
      SPRINGDOC_SWAGGER_UI_TAGS_SORTER: ${SPRINGDOC_SWAGGER_UI_TAGS_SORTER:-alpha}

      # JVM настройки
      JAVA_OPTS: ${JAVA_OPTS:--Xmx512m -Xms512m}

      # Путь для хранения изображений книг (внутри контейнера фиксированный)
      APP_IMAGES_STORAGE_PATH: /opt/spring-digital-bookstore/pictures
      # Путь для хранения PDF файлов книг (внутри контейнера фиксированный)
      APP_PDF_STORAGE_PATH: /opt/spring-digital-bookstore/pdf

      # Frontend URL для редиректа после оплаты
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}

      # Stripe настройки
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_51Sn9eKF06mQasm4mhBSG71Wes6rz09BTuQicIu37oRIw5agFgZuGMGZQk4IeftRm2aQGJXFma5IPwm1iT77WlALs00VDZNJkEL}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-test-value}
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost/api/v1/payment/success}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost/api/v1/payment/cancel}

      # OpenAI API настройки
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-value}

      # Gemini API настройки
      GEMINI_API_KEY: ${GEMINI_API_KEY:-test-value}

      # Kafka Configuration для отправки событий
      KAFKA_BOOTSTRAP_SERVERS: kafka-broker:29092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-broker:29092

      # Telegram настройки для отправки сообщений в Telegram Bot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-test-value}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-test-value}

      # SMTP настройки для отправки email через MailHog
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME:-}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD:-}
      SPRING_MAIL_SMTP_AUTH: ${SPRING_MAIL_SMTP_AUTH:-false}
      SPRING_MAIL_SMTP_STARTTLS_ENABLE: ${SPRING_MAIL_SMTP_STARTTLS_ENABLE:-false}
      SPRING_MAIL_SMTP_SSL_ENABLE: ${SPRING_MAIL_SMTP_SSL_ENABLE:-false}
      SPRING_MAIL_FROM: ${SPRING_MAIL_FROM:-noreply@localhost}

      # Base URL для ссылок подтверждения email (должен соответствовать порту, на котором доступен backend)
      APP_EMAIL_VERIFICATION_BASE_URL: ${APP_EMAIL_VERIFICATION_BASE_URL:-http://localhost}

      # ELK Stack настройки для отправки логов в Logstash
      LOGSTASH_HOST: logstash
      LOGSTASH_PORT: 5000

      # Включить/выключить Logstash (по умолчанию в application.properties выключен)
      LOGSTASH_ENABLED: "true"
      # Включить/выключить Kafka (по умолчанию в application.properties выключен)
      KAFKA_ENABLED: "true"

    ports:
      - "8088:8080"
    volumes:
      # Хранение изображений книг в обычной директории на хосте (для Windows используйте формат C:/path/to/dir)
      - ${APP_IMAGES_STORAGE_PATH:-C:/spring-digital-bookstore/pictures}:/opt/spring-digital-bookstore/pictures
      # Хранение PDF файлов книг в обычной директории на хосте (для Windows используйте формат C:/path/to/dir)
      - ${APP_PDF_STORAGE_PATH:-C:/spring-digital-bookstore/pdf}:/opt/spring-digital-bookstore/pdf
    networks:
      - spring-library-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      mailhog:
        condition: service_started
    restart: unless-stopped

  # Elasticsearch для хранения логов
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      # Увеличиваем память до 1GB для стабильной работы
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      # Отключаем memory_lock для Windows/Docker (может не работать)
      - bootstrap.memory_lock=false
      # Настройки для более быстрой работы в dev окружении
      - action.auto_create_index=true
      - cluster.routing.allocation.disk.threshold_enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${ELASTICSEARCH_DATA_PATH:-C:/spring-digital-bookstore/elasticsearch_data}:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - spring-library-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=30s || exit 1",
        ]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 120s
    restart: unless-stopped

  # Logstash для приема и обработки логов
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: logstash
    depends_on:
      elasticsearch:
        condition: service_healthy
    ports:
      - "5000:5000"
      - "5044:5044"
      - "9600:9600"
    environment:
      - "LS_JAVA_OPTS=-Xmx256m -Xms256m"
    command:
      - /bin/bash
      - -c
      - |
        mkdir -p /usr/share/logstash/pipeline /usr/share/logstash/config
        cat > /usr/share/logstash/config/pipelines.yml << 'PIPELINES_EOF'
        # Конфигурация pipelines для Logstash
        - pipeline.id: main
          path.config: "/usr/share/logstash/pipeline/logstash.conf"
        PIPELINES_EOF
        cat > /usr/share/logstash/config/logstash.yml << 'LOGSTASH_EOF'
        http.host: "0.0.0.0"
        xpack.monitoring.elasticsearch.hosts: [ "http://elasticsearch:9200" ]
        LOGSTASH_EOF
        cat > /usr/share/logstash/pipeline/logstash.conf << 'LOGCONF_EOF'
        input {
          tcp {
            port => 5000
            codec => json_lines
          }
        }

        filter {
          # logstash-logback-encoder отправляет JSON напрямую через TCP с codec json_lines
          # Все поля уже доступны напрямую (level, message, service, @timestamp, logger_name, thread_name и т.д.)

          # Добавление метаданных для индексации на основе поля service
          mutate {
            add_field => { "[@metadata][index]" => "%{service}-logs-%{+YYYY.MM.dd}" }
          }

          # Если service не определен, используем значение по умолчанию
          if ![service] {
            mutate {
              add_field => { "service" => "unknown" }
            }
          }

          # Фильтрация чувствительных данных (пароли, токены)
          # Раскомментируйте, если нужно маскировать чувствительные данные
          # mutate {
          #   gsub => [
          #     "message", "(?i)(password|token|secret|key|api[_-]?key)=[^&\s\"']+", "\1=***",
          #     "message", "(?i)(\"password\"\\s*:\\s*\")([^\"]+)(\")", "\1***\3",
          #     "message", "(?i)(\"token\"\\s*:\\s*\")([^\"]+)(\")", "\1***\3"
          #   ]
          # }
        }

        output {
          elasticsearch {
            hosts => ["elasticsearch:9200"]
            # Динамический индекс на основе поля service
            index => "%{[@metadata][index]}"
            # Или можно использовать фиксированные индексы:
            # index => "%{service}-logs-%{+YYYY.MM.dd}"
          }

          # Fallback на stdout для отладки (опционально, можно закомментировать в продакшене)
          stdout {
            codec => rubydebug
          }
        }
        LOGCONF_EOF
        exec /usr/local/bin/docker-entrypoint
    networks:
      - spring-library-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9600/_node/stats || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Kibana для визуализации логов
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    depends_on:
      elasticsearch:
        condition: service_healthy
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      # Увеличиваем таймауты для создания индексов
      - ELASTICSEARCH_REQUEST_TIMEOUT=120000
      # Настройки для более быстрого старта
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=changeme-changeme-changeme-changeme
      - XPACK_REPORTING_ENCRYPTIONKEY=changeme-changeme-changeme-changeme
      - XPACK_SECURITY_ENCRYPTIONKEY=changeme-changeme-changeme-changeme
    networks:
      - spring-library-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    restart: unless-stopped

  # Prometheus для сбора метрик
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      # Volume для хранения данных Prometheus (опционально для персистентности)
      - ${PROMETHEUS_DATA_PATH:-C:/spring-digital-bookstore/prometheus_data}:/prometheus
    entrypoint:
      - /bin/sh
      - -c
      - |
        cat > /etc/prometheus/prometheus.yml << 'PROMETHEUS_EOF'
        global:
          scrape_interval: 15s
          evaluation_interval: 15s
          external_labels:
            cluster: 'local'
            environment: 'development'
        rule_files:
        scrape_configs:
          - job_name: 'prometheus'
            static_configs:
              - targets: ['localhost:9090']
                labels:
                  service: 'prometheus'
          - job_name: 'backend'
            metrics_path: '/actuator/prometheus'
            static_configs:
              - targets: ['backend:8080']
                labels:
                  service: 'backend'
                  application: 'spring-digital-library'
            scrape_interval: 10s
          - job_name: 'analytics-service'
            metrics_path: '/actuator/prometheus'
            static_configs:
              - targets: ['analytics-service:8090']
                labels:
                  service: 'analytics-service'
                  application: 'analytics-service'
            scrape_interval: 10s
          - job_name: 'windows'
            static_configs:
              - targets: ['192.168.0.22:9182']
        PROMETHEUS_EOF
        exec /bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus --storage.tsdb.retention.time=15d --web.console.libraries=/usr/share/prometheus/console_libraries --web.console.templates=/usr/share/prometheus/consoles
    networks:
      - spring-library-network
    depends_on:
      backend:
        condition: service_started
      analytics-service:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Grafana для визуализации метрик
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      # Настройки администратора Grafana
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      # Отключить вход через Google/GitHub (для локальной разработки)
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      # Настройки для автоматической настройки datasource
      GF_INSTALL_PLUGINS: ""
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /etc/grafana/provisioning/datasources /etc/grafana/provisioning/dashboards /var/lib/grafana/dashboards
        cat > /etc/grafana/provisioning/datasources/prometheus.yml << 'DATASOURCE_EOF'
        apiVersion: 1

        datasources:
          - name: Prometheus
            type: prometheus
            access: proxy
            url: http://prometheus:9090
            isDefault: true
            editable: true
            jsonData:
              timeInterval: "15s"
              httpMethod: POST
        DATASOURCE_EOF
        cat > /etc/grafana/provisioning/dashboards/dashboards.yml << 'DASHBOARDS_EOF'
        apiVersion: 1

        providers:
          - name: 'Default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            updateIntervalSeconds: 10
            allowUiUpdates: true
            options:
              path: /var/lib/grafana/dashboards
              foldersFromFilesStructure: true
        DASHBOARDS_EOF
        cat > /var/lib/grafana/dashboards/application-metrics.json << 'DASHBOARD_JSON_EOF'
        {
          "title": "Application Metrics Dashboard",
          "id": null,
          "uid": "application-metrics",
          "tags": ["spring-boot", "prometheus", "application"],
          "description": "Дашборд для мониторинга метрик Spring Boot приложения: HTTP запросы, производительность, JVM, база данных, Kafka",
          "timezone": "browser",
          "schemaVersion": 38,
          "version": 1,
          "refresh": "10s",
          "panels": [
            {
              "id": 1,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
              "type": "timeseries",
              "title": "HTTP Request Rate (requests/sec)",
              "description": "Общая скорость обработки HTTP запросов (requests per second). Метрика: http_server_requests_seconds_count - количество всех HTTP запросов, rate вычисляет скорость за 5 минут",
              "targets": [
                {
                  "expr": "sum(rate(http_server_requests_seconds_count[5m])) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}}"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "red", "value": 100}
                    ]
                  },
                  "unit": "reqps"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 2,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
              "type": "timeseries",
              "title": "HTTP Request Rate by Status",
              "description": "Скорость HTTP запросов, разбитая по статус-кодам: 200 OK (успешные), 4xx (ошибки клиента), 5xx (ошибки сервера). Помогает отслеживать долю успешных и проблемных запросов",
              "targets": [
                {
                  "expr": "sum(rate(http_server_requests_seconds_count{status=\"200\"}[5m])) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}} - 200 OK"
                },
                {
                  "expr": "sum(rate(http_server_requests_seconds_count{status=~\"4..\"}[5m])) by (job)",
                  "refId": "B",
                  "legendFormat": "{{job}} - 4xx"
                },
                {
                  "expr": "sum(rate(http_server_requests_seconds_count{status=~\"5..\"}[5m])) by (job)",
                  "refId": "C",
                  "legendFormat": "{{job}} - 5xx"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 10},
                      {"color": "red", "value": 50}
                    ]
                  },
                  "unit": "reqps"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 3,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
              "type": "timeseries",
              "title": "HTTP Error Rate (4xx & 5xx)",
              "description": "Скорость возникновения HTTP ошибок: 4xx (ошибки клиента, например 404, 400) и 5xx (ошибки сервера, например 500, 503). Метрики: http_errors_4xx_total и http_errors_5xx_total",
              "targets": [
                {
                  "expr": "sum(rate(http_errors_4xx_total[5m])) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}} - 4xx Errors"
                },
                {
                  "expr": "sum(rate(http_errors_5xx_total[5m])) by (job)",
                  "refId": "B",
                  "legendFormat": "{{job}} - 5xx Errors"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 2,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 0.1},
                      {"color": "red", "value": 1}
                    ]
                  },
                  "unit": "reqps"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 4,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
              "type": "timeseries",
              "title": "Response Time (p95, p99)",
              "description": "Время отклика HTTP запросов: p95 (95% запросов быстрее этого значения) и p99 (99% запросов быстрее). Вычисляется из гистограммы http_server_requests_seconds_bucket. Пороги: желтый при 0.5с, красный при 1с",
              "targets": [
                {
                  "expr": "histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, job))",
                  "refId": "A",
                  "legendFormat": "{{job}} - p95"
                },
                {
                  "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, job))",
                  "refId": "B",
                  "legendFormat": "{{job}} - p99"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 2,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "line"}
                  },
                  "mappings": [],
                  "max": 5,
                  "min": 0,
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 0.5},
                      {"color": "red", "value": 1}
                    ]
                  },
                  "unit": "s"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 5,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
              "type": "timeseries",
              "title": "JVM Heap Memory Usage",
              "description": "Использование heap памяти JVM в процентах: Used (используемая память) и Committed (выделенная JVM память). Метрики: jvm_memory_used_bytes, jvm_memory_committed_bytes, jvm_memory_max_bytes. Пороги: желтый при 70%, красный при 85%",
              "targets": [
                {
                  "expr": "sum(jvm_memory_used_bytes{area=\"heap\"}) by (job) / sum(jvm_memory_max_bytes{area=\"heap\"}) by (job) * 100",
                  "refId": "A",
                  "legendFormat": "{{job}} - Used"
                },
                {
                  "expr": "sum(jvm_memory_committed_bytes{area=\"heap\"}) by (job) / sum(jvm_memory_max_bytes{area=\"heap\"}) by (job) * 100",
                  "refId": "B",
                  "legendFormat": "{{job}} - Committed"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 20,
                    "gradientMode": "opacity",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "area"}
                  },
                  "mappings": [],
                  "max": 100,
                  "min": 0,
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 70},
                      {"color": "red", "value": 85}
                    ]
                  },
                  "unit": "percent"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 6,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
              "type": "timeseries",
              "title": "JVM Threads",
              "description": "Количество потоков JVM: Live Threads (текущее количество активных потоков) и Peak Threads (максимальное количество потоков за время работы). Метрики: jvm_threads_live_threads, jvm_threads_peak_threads",
              "targets": [
                {
                  "expr": "jvm_threads_live_threads",
                  "refId": "A",
                  "legendFormat": "{{job}} - Live Threads"
                },
                {
                  "expr": "jvm_threads_peak_threads",
                  "refId": "B",
                  "legendFormat": "{{job}} - Peak Threads"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null}
                    ]
                  },
                  "unit": "short"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 7,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
              "type": "timeseries",
              "title": "Database Connection Pool",
              "description": "Метрики пула соединений HikariCP: Active % (процент активных соединений от максимума), Idle (простаивающие соединения), Pending (запросы в очереди на получение соединения). Метрики: hikaricp_connections_active, hikaricp_connections_idle, hikaricp_connections_pending, hikaricp_connections_max. Пороги: желтый при 80%, красный при 95%",
              "targets": [
                {
                  "expr": "hikaricp_connections_active / hikaricp_connections_max * 100",
                  "refId": "A",
                  "legendFormat": "{{pool}} - Active %"
                },
                {
                  "expr": "hikaricp_connections_idle",
                  "refId": "B",
                  "legendFormat": "{{pool}} - Idle"
                },
                {
                  "expr": "hikaricp_connections_pending",
                  "refId": "C",
                  "legendFormat": "{{pool}} - Pending"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "line"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 80},
                      {"color": "red", "value": 95}
                    ]
                  },
                  "unit": "percent"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 8,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
              "type": "timeseries",
              "title": "Kafka Messages",
              "description": "Скорость обработки сообщений Kafka: Produced (сообщений отправлено в секунду) и Consumed (сообщений получено в секунду). Метрики: spring_kafka_template_seconds_count (отправка), spring_kafka_listener_seconds_count (получение). Единица измерения: messages per second (msgps)",
              "targets": [
                {
                  "expr": "sum(rate(spring_kafka_template_seconds_count{result=\"success\"}[5m])) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}} - Produced"
                },
                {
                  "expr": "sum(rate(spring_kafka_listener_seconds_count{result=\"success\"}[5m])) by (job)",
                  "refId": "B",
                  "legendFormat": "{{job}} - Consumed"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null}
                    ]
                  },
                  "unit": "msgps"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 9,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
              "type": "table",
              "title": "Top 10 Error Endpoints",
              "description": "Таблица топ-10 эндпоинтов с наибольшим количеством ошибок. Показывает path (путь), status (HTTP статус), error_type (тип ошибки) и скорость ошибок. Метрика: http_errors_by_status_total. Сортировка по убыванию скорости ошибок",
              "targets": [
                {
                  "expr": "topk(10, sum by (path, status, error_type) (rate(http_errors_by_status_total[5m])))",
                  "refId": "A",
                  "format": "table",
                  "instant": true
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "custom": {
                    "align": "auto",
                    "cellOptions": {
                      "type": "auto"
                    },
                    "inspect": false
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null}
                    ]
                  }
                },
                "overrides": []
              },
              "options": {
                "showHeader": true,
                "sortBy": [
                  {
                    "desc": true,
                    "displayName": "Value"
                  }
                ]
              }
            },
            {
              "id": 10,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
              "type": "stat",
              "title": "Active Requests",
              "description": "Текущее количество активных (обрабатываемых в данный момент) HTTP запросов. Метрика: http_server_requests_active_seconds_count. Пороги: желтый при 50, красный при 100 активных запросах",
              "targets": [
                {
                  "expr": "sum(http_server_requests_active_seconds_count) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}}"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "thresholds"},
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 50},
                      {"color": "red", "value": 100}
                    ]
                  },
                  "unit": "short"
                }
              },
              "options": {
                "colorMode": "value",
                "graphMode": "area",
                "justifyMode": "auto",
                "orientation": "auto",
                "reduceOptions": {
                  "values": false,
                  "calcs": ["lastNotNull"],
                  "fields": ""
                },
                "textMode": "auto"
              }
            },
            {
              "id": 11,
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 40},
              "type": "timeseries",
              "title": "CPU Usage",
              "description": "Использование CPU в процентах: Process CPU (использование CPU процессом приложения) и System CPU (общее использование CPU системой). Метрики: process_cpu_usage, system_cpu_usage. Пороги: желтый при 70%, красный при 90%",
              "targets": [
                {
                  "expr": "process_cpu_usage * 100",
                  "refId": "A",
                  "legendFormat": "{{job}} - Process CPU"
                },
                {
                  "expr": "system_cpu_usage * 100",
                  "refId": "B",
                  "legendFormat": "System CPU"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "line"}
                  },
                  "mappings": [],
                  "max": 100,
                  "min": 0,
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 70},
                      {"color": "red", "value": 90}
                    ]
                  },
                  "unit": "percent"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            },
            {
              "id": 12,
              "gridPos": {"h": 8, "w": 12, "x": 12, "y": 40},
              "type": "timeseries",
              "title": "GC Pause Time",
              "description": "Время пауз сборщика мусора (Garbage Collector): Avg GC Pause (среднее время паузы) и Max GC Pause (максимальное время паузы). Метрики: jvm_gc_pause_seconds_sum, jvm_gc_pause_seconds_count, jvm_gc_pause_seconds_max. Пороги: желтый при 0.1с, красный при 0.5с",
              "targets": [
                {
                  "expr": "sum(rate(jvm_gc_pause_seconds_sum[5m])) by (job) / sum(rate(jvm_gc_pause_seconds_count[5m])) by (job)",
                  "refId": "A",
                  "legendFormat": "{{job}} - Avg GC Pause"
                },
                {
                  "expr": "jvm_gc_pause_seconds_max",
                  "refId": "B",
                  "legendFormat": "{{job}} - Max GC Pause"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "color": {"mode": "palette-classic"},
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {"type": "linear"},
                    "showPoints": "never",
                    "spanNulls": false,
                    "stacking": {"group": "A", "mode": "none"},
                    "thresholdsStyle": {"mode": "off"}
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {"color": "green", "value": null},
                      {"color": "yellow", "value": 0.1},
                      {"color": "red", "value": 0.5}
                    ]
                  },
                  "unit": "s"
                }
              },
              "options": {
                "tooltip": {"mode": "multi"},
                "legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom"}
              }
            }
          ],
          "time": {
            "from": "now-6h",
            "to": "now"
          },
          "timepicker": {},
          "templating": {
            "list": []
          },
          "annotations": {
            "list": []
          },
          "editable": true,
          "fiscalYearStartMonth": 0,
          "graphTooltip": 0,
          "links": [],
          "liveNow": false,
          "weekStart": ""
        }
        DASHBOARD_JSON_EOF
        exec /run.sh
    networks:
      - spring-library-network
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

networks:
  spring-library-network:
    driver: bridge
